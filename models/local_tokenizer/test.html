<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ ØªÙˆØ±Ù‡Ø§</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.12.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    body { font-family: sans-serif; background: #f0f0f0; margin: 0; padding: 20px; direction: rtl; }
    #chat { max-width: 720px; margin: auto; background: white; border-radius: 10px; padding: 20px; }
    #messages { max-height: 400px; overflow-y: auto; margin-bottom: 10px; }
    .message { margin: 10px 0; padding: 10px; border-radius: 6px; }
    .user { background-color: #cce5ff; text-align: right; }
    .bot { background-color: #eeeeee; text-align: left; white-space: pre-line; }
    input { width: 70%; padding: 10px; }
    button { padding: 10px 20px; background-color: #0077cc; color: white; border: none; border-radius: 5px; }
  </style>
</head>
<body>

<div id="chat">
  <h2>Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ ØªÙˆØ±Ù‡Ø§ÛŒ Ø®Ø§Ø±Ø¬ÛŒ</h2>
  <div id="messages"></div>
  <input type="text" id="userInput" placeholder="Ù…Ø«Ù„Ø§Ù‹: ØªÙˆØ± Ø¨Ø±Ø²ÛŒÙ„ Ø¯Ø± Ú©Ø¯Ø§Ù… Ù…Ø§Ù‡ Ø¨Ø±Ú¯Ø²Ø§Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŸ" />
  <button id="sendBtn">Ø§Ø±Ø³Ø§Ù„</button>
</div>

<script>
let model;
let tokenizer;
let tours = [];
let toursEmbeddings = [];

// Load tokenizer
async function loadTokenizer() {
  const { AutoTokenizer } = window.transformers;
  tokenizer = await AutoTokenizer.from_pretrained('Xenova/parsbert-base-uncased');
  console.log("âœ… ØªÙˆÚ©Ù†Ø§ÛŒØ²Ø± ÙØ§Ø±Ø³ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯");
}

// Load model
async function loadModel() {
  model = await tf.loadGraphModel("model.json");
  console.log("âœ… Ù…Ø¯Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯");
}

// Prepare tour text
function buildText(tour) {
  return `${tour.title} ${tour.country} ${tour.month} ${tour.description}`;
}

// Get embedding from model
async function getEmbedding(text) {
  const tokens = tokenizer(text, { padding: true, truncation: true, max_length: 128 });
  const input_ids = tf.tensor(tokens.input_ids.data, tokens.input_ids.dims, 'int32');
  const attention_mask = tf.tensor(tokens.attention_mask.data, tokens.attention_mask.dims, 'int32');
  const outputs = await model.executeAsync({ input_ids, attention_mask });
  const embedding = outputs.last_hidden_state.mean(1); // mean pooling
  return embedding;
}

// Cosine similarity
function cosineSimilarity(t1, t2) {
  const dot = tf.sum(tf.mul(t1, t2));
  const norm1 = tf.norm(t1);
  const norm2 = tf.norm(t2);
  return dot.div(norm1.mul(norm2));
}

// Get intelligent answer
async function getAnswer(question) {
  const qEmbed = await getEmbedding(question);
  const sims = toursEmbeddings.map((embed, idx) => {
    const score = cosineSimilarity(qEmbed, embed).dataSync()[0];
    return { tour: tours[idx], score };
  });

  const top = sims.filter(s => s.score > 0.6).sort((a, b) => b.score - a.score);

  if (top.length === 0)
    return "Ù…ØªØ§Ø³ÙÙ…ØŒ ØªÙˆØ±ÛŒ Ù…Ø±ØªØ¨Ø· Ø¨Ø§ Ø³ÙˆØ§Ù„ ÛŒØ§ÙØª Ù†Ø´Ø¯.";

  let msg = `ØªØ¹Ø¯Ø§Ø¯ ${top.length} ØªÙˆØ± Ù…Ø±ØªØ¨Ø· ÛŒØ§ÙØª Ø´Ø¯:\n\n`;
  top.forEach((t, i) => {
    msg += `${i + 1}. ${t.tour.title} â€“ ${t.tour.duration} â€“ ${t.tour.price}\nðŸ“… ${t.tour.start_date} (${t.tour.month})\nðŸ”— ${t.tour.url}\n\n`;
  });
  return msg.trim();
}

// UI helpers
function addMessage(type, text) {
  const div = document.createElement("div");
  div.className = "message " + type;
  div.textContent = text;
  document.getElementById("messages").appendChild(div);
  document.getElementById("messages").scrollTop = 99999;
}

document.getElementById("sendBtn").addEventListener("click", async () => {
  const input = document.getElementById("userInput").value.trim();
  if (!input) return;
  addMessage("user", input);
  document.getElementById("userInput").value = "";
  addMessage("bot", "â³ Ø¯Ø± Ø­Ø§Ù„ ØªØ­Ù„ÛŒÙ„ Ø³ÙˆØ§Ù„...");

  const reply = await getAnswer(input);
  const botMsgs = document.querySelectorAll(".bot");
  botMsgs[botMsgs.length - 1].remove();
  addMessage("bot", reply);
});

// Initialization
(async () => {
  await loadTokenizer();
  await loadModel();
  const res = await axios.get("tours.json");
  tours = res.data.tours;

  for (const tour of tours) {
    const text = buildText(tour);
    const embed = await getEmbedding(text);
    toursEmbeddings.push(embed);
  }

  console.log("âœ… Ø¢Ù…Ø§Ø¯Ù‡ Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯");
})();
</script>

</body>
</html>
